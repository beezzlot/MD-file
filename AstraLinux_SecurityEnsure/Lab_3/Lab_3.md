# Лабораторная работа №3. Тема: "Шифрование информации"
Цель работы
----------

изучить технические решения, которые существуют на российском рынке, по обеспечению шифрования и организации безопасного доступа


Оборудование, ПО:
----------
Виртуальная машина под управлением ОС Astra Linux 1.7  в режиме защищенности "Воронеж"


Ход работы:
----------
Целью данной лабораторной работы является ознакомление с инструментами обеспечения шифрования и защиты от НСД для Astra Linux. 


# Какие технические решения есть? 

Конечно, данной лабораторной работой все технические решения мы не перечислим. Что-то могло забыться, а что-то не совсем актуально в рабочих задачах. 

В основном, в большинстве государственных организациях или в объектах критической инфраструктуры вы встретитесь с ними:

1. КриптПро;

2. SecretNet;

3. Kaspersky;

4. dm-crypt.




## Начнем с КриптоПро

КриптоПро — это специальный криптопровайдер, предназначенный для подписи и шифрования. Без применения таких программ, как КриптоПро, использование ЭЦП становится невозможным. Криптопровайдер — модуль, который устанавливается непосредственно на персональный компьютер и предназначен для защиты данных от изменения третьими лицами.

Электронная подпись (ЭП или ЭЦП) — это цифровой аналог рукописной подписи. Электронные ключи используют в разных областях: для подписания электронных документов с контрагентами, сдачи отчётности, регистрации онлайн-кассы, участия в торгах, работы на госпорталах и т.д.

При подписании документа электронной подписью сохраняются данные о том, когда и кем был подписан файл. Если в документ внесут изменения после подписания, об этом можно будет узнать.

Хранится ЭЦП на токене.

Токен для ЭЦП — это ключевой носитель для записи сертификата и ключей электронной подписи (ЭП). Ещё его называют аппаратным или программным ключом.

Одним из основных производителей ЭЦП в России - компания "Актив" и их продукт "Рутокен". Выглядит токен примерно так:

![Картинка](Screen1.png)

Или так:

![Картинка](Screen2.png)



## А как нам попробовать работу с этим продуктом?

Да, конечно для лабораторной работы мы не сможем каждому предоставить ЭЦП-токен, так что рассмотрим только функционал самого криптопровайдера. 

КриптоПро - платное программное обеспечение, с возможностью демо-версии в 3 месяца. Этим и воспользуемся. 


## Установка КриптоПро

Архив с программным обеспечением КриптоПро CSP доступен для загрузки на официальном сайте [www.cryptopro.ru](https://www.cryptopro.ru/products/csp). 

Для загрузки требуется регистрация на сайте.

Скачается архив - "linux_amd64_deb.tgz", распакуйте его:

```
tar -xvf linux-amd64_deb.tgz
```

После этого, перейдем в распакованный каталог и запустим скрипт установки с правами администратора:

```
sudo ./install_gui.sh
```

![Картинка](Screen3.png)

Для полной работы с ЭЦП выберите: 

* Поддержка токенов и смарт-карт;

* Импортирование из ОС сертификатов.

![Картинка](Screen4.png)


Итоговый перечень установленных программ:

![Картинка](Screen5.png)


После установки, система уведомит вас о успехах соответствующим уведомлением

![Картинка](Screen6.png)


Проверить, что все работает можно командой:

```
/opt/cprocsp/sbin/amd64/cpconfig -license -view
```


![Картинка](Screen7.png)

Для установки лицензии выполнить команду:

```
sudo /opt/cprocsp/sbin/amd64/cpconfig -license -set <номер_лицензии>
```

Примеры использования КриптоПро в Astra Linux можно увидеть тут: [Ссылка](https://wiki.astralinux.ru/pages/viewpage.action?pageId=32833902)


### Категории сертификатов

**Из документации Astra Linux**

Сертификаты делятся на четыре категории:

* личные сертификаты (устанавливаются в хранилище umy, где u = User, my - имя хранилища). Для таких сертификатов, как правило, имеется закрытый ключ (и они требуют особой установки, чтобы в хранилище появилась ссылка на этот закрытый ключ). В результате с их использованием можно, например, подписать файл;

* корневые сертификаты - краеугольный камень безопасности, так как цепочки доверия строятся от них.  Корневые сертификаты надо добавлять в хранилища осознанно и внимательно (устанавливаются в uroot, также администратор может поставить их в mroot, где m = Machine, такие сертификаты будут доступны в режиме read only в root-хранилищах всех пользователей);

* промежуточные сертификаты - появляются, когда есть промежуточные УЦ (структура вида "головной УЦ" -> "промежуточный УЦ" -> "пользовательский сертификат"). Прямое доверие к ним не требуется (устанавливаются в uca, также администратор может поставить их в mca). В это же хранилище устанавливаются и списки отзыва сертификатов (CRL). Обычно точки получения промежуточных сертификатов и списков отзыва (CRL) правильно указаны в пользовательских сертификатах, поэтому они загружаются автоматически и устанавливаются в хранилище ucache. Обычно непосредственная работа с промежуточными сертификатами не требуется;

* сертификаты партнёров по общению, чтобы проверять их подписи и зашифровывать для них сообщения. Ставятся либо в umy (это не лучшая, но распространенная практика), либо в uAddressBook.

### Графический интерфейс КриптоПро

"Меню Пуск" --> "Утилиты" --> "Инструменты КриптоПро"

![Картинка](Screen8.png)

Здесь можно в удобной форме также поработать с КриптоПро и токенами. 


## Установка SecretNet

Программное обеспечение Secret Net Studio – комплексное решение для защиты рабочих станций и серверов на уровне данных, приложений, сети, операционной системы и периферийного оборудования. Secret Net Studio предлагает защиту информации от несанкционированного доступа, антивирусную защиту, межсетевое экранирование, контроль действий приложений и защиту от сетевых атак, шифрование контейнеров, создание защищенного соединения с удаленными компьютерами и многое другое.


Также как и КриптПро данное решение является платным, но имеет функционал "демоверсии" после процедуры регистрации.

[Скачать тут](https://www.securitycode.ru/download_center/)


Скачать, распаковать и перейти в папку:

![Картинка](Screen9.png)


В папке Documentation есть инструкции по установке. 

![Картинка](Screen10.png)


Выполните установку:

```
apt install ./sns_8.0-302.astra1.7_amd64.deb
```

![Картинка](Screen11.png)

И вот ошибка!

![Картинка](Screen12.png)

SecretNet привязыван к ядру операционной системы, установим ту версию, что требуется ПО. 

Конкретно в нашем случае, нам будет проще установить версию - 5.4.0-162.astra1+ci6



Для этого нам потребуется подключить только следующие репозитории в /etc/apt/sources.list:

```
deb http://dl.astralinux.ru/astra/frozen/1.7_x86-64/1.7.5/repository-main/ 1.7_x86-64 main contrib non-free
deb http://dl.astralinux.ru/astra/frozen/1.7_x86-64/1.7.5/repository-update/ 1.7_x86-64 main contrib non-free
```

Для установки конкретной версии ПО:

```
apt install linux-image-5.4.0-162-generic= 5.4.0-162.astra1+ci6
```

После установки


Соответственно, как через терминал указать ядро, загружаемое по умолчанию?

```
sudo grep 'menuentry ' /boot/grub/grub.cfg | cut -f 2 -d "'" | nl -v 0
```

Вывод будет примерно такой:

```
0  AstraLinuxSE GNU/Linux
1  AstraLinuxSE GNU/Linux, with Linux 5.15.0-33-hardened
2  AstraLinuxSE GNU/Linux, with Linux 5.15.0-33-hardened (recovery mode)
3  AstraLinuxSE GNU/Linux, with Linux 5.15.0-33-generic
4  AstraLinuxSE GNU/Linux, with Linux 5.15.0-33-generic (recovery mode)
```

Далее укажите в файле **/etc/default/grub** в параметре GRUB_DEFAULT номер того ядра, что вы желаете запустить. 

Чтобы обновить настройки, введите команду:

```
sudo update-grub
```

Установим следующую версию ядра - 5.15.0-83.astra1+ci14























При этом 

```
Настройка сертифицированных операционных систем на базе ядра Linux осуществляется в соответствии с эксплуатационной документацией разработчиков операционных систем.
```

Это не значит, что инструменты описанные в данном документе мы можем не использовать только потому, что работаем на сертифицированной Astra Linux. 

Знакомится с этим документом нужно, а также применять его на практике, чтобы по итогу, используя рекомендации как ФСТЭК, так и вендора - получить безопасную и надежную ОС. 


Документ разделен на разделы:

* настройка авторизации в операционной системе;

* ограничение механизмов получения привилегий;

* настройка прав доступа к объектам файловой системы;

* настройка механизмов защиты ядра Linux;

* уменьшение периметра атаки ядра Linux;

* настройка средств защиты пользовательского пространства со стороны ядра Linux.


## Настройка авторизации в операционных системах Linux

### 1. Не допускать использование учетных записей с пустыми паролями. 

При установке различных программ - например, Apache2 или Nginx, или SSHD. В системе появляется служебный пользователь. По умолчанию, он без пароля и без терминального доступа, но существуют компьютерные атаки, направленные как раз на существование таких "пустых" учетных записей. 

Для того чтобы не допустить использование учетных записей пользователей с пустыми паролями в Linux, вам следует выполнить следующие шаги:

1. Откройте терминал и войдите в систему под учетной записью с правами администратора.

2. Отредактируйте файл /etc/login.defs с помощью текстового редактора. Например, выполните команду:

```
sudo nano /etc/login.defs
```



3. Найдите и измените параметр PASSMINLEN на значение 1 или больше. Этот параметр устанавливает минимальную длину пароля.

```
PASS_MIN_LEN 1
```


4. Сохраните изменения в файле login.defs и закройте текстовый редактор.

5. Обновите файл /etc/shadow командой:

```
sudo pwconv
```


Теперь пользователи не смогут установить пустой пароль, причему  Если вы хотите заблокировать учетную запись пользователя, вы можете использовать команду passwd с опцией -l для блокировки:

```
sudo passwd -l username
```


### 2. Обеспечить отключение входа суперпользователя по протоколу SSH.

В файле /etc/ssh/sshd_config

![Картинка](Screen1.png)


### 3. Запретить использование команды sudo и su 

Команда "su" в UNIX-подобных операционных системах (как Linux) используется для переключения пользователя на другого, обычно более привилегированного, например, на суперпользователя (root).

Для ограничения доступа к команде su используется механизм PAM модуля pam_wheel.

По умолчанию данный модуль отключен.

Для включения разграничения доступа к команде su по системной группе astra-admin необходимо в файле /etc/pam.d/su изменить строку:

```
#auth       required   pam_wheel.so
```

На

```
auth       required   pam_wheel.so group=astra-admin
```

Если имя группы имеет пробел, например, domain group, то можно использовать синтаксис:

```
auth       required   pam_wheel.so [group=domain group]
```

После этого командой su смогут пользоваться только пользователи группы astra-admin  или domain group.



### 4. Органичить список пользователей, которым разрешен доступ к команде sudo

Команда sudo в UNIX-подобных операционных системах также используется для выполнения команд с повышенными привилегиями, например, от имени суперпользователя (root). Это позволяет пользователям без необходимости входа под суперпользователем выполнять административные задачи.


Информацию о том, кто может использовать команду **sudo** операционная система хранит в файле - **/etc/sudoers** и **/etc/sudoers.d** 

**Редактировать данные файлы напрямую, через различные текстовые редакторы - идея плохая, ведь если вы случайно допустите ошибку или опечатку в них, есть риск потерять административный доступ до операционной системы**

Для безопасного редактирования файла используйте команду - **visudo**

Рассмотрим на примере, чем редактирование файла /etc/sudoers без специальной команды может быть опасно.

P.S. Не проверять на реальной машине! Это может привести к потере доступа! 

```
vim /etc/sudoers
```

![Картинка](Screen2.png)

Допустили специальную ошибку, сохраняем и выходим из документа

![Картинка](Screen3.png)

И все! Теперь команда sudo недоступна.

А если бы мы работали через visudo?

![Картинка](Screen4.png)

То система бы сразу предупредила нас о проблемах! 

Ладно, на этом "вредные" советы закончились, что у нас с правилами sudo?


![Картинка](Screen5.png)


По-умолчанию, пользователь root, члены группы sudo и astra-admin имеют полный доступ до команды **sudo**.

Вы можете это поменять по своему усмотрению, например, если планируется выдать доступ для всех членов доменной группы: 

```
%domain\ admins ALL=(ALL:ALL) ALL
```

В этом случае, все члены доменной группы Domain Admins 
получат доступ до этой повышенных привилегий.

#### А что если мы планируем дать доступ только до определенных команд?

Например, 

```
a-admin-domain ALL=NOPASSWD: /bin/tar, /usr/bin/chown
```

И вот так, получится выдать доступ до конкретных команд определенным пользователям и группам. 

### 5. Настройка прав доступа к объектам файловой системы

Установить корректные права доступа к файлам настройки пользователей, а именно к файлам с перечнями пользовательских идентификаторов (/etc/passwd) и групп (/etc/group), либо хранилищам хешей паролей
(в операционных системах GNU/Linux, Solaris, HP-UX: /etc/shadow, AIX: /etc/security/passwd), с помощью команд:

```
chmod 644 /etc/passwd;

chmod 644 /etc/group;

chmod go-rwx /etc/shadow.
```

Установить корректные права доступа к системным файлам заданий (конфигурационным файлам) cron при помощи команд:

```
chmod go-wx /etc/crontab

chmod go-wx /etc/cron.d

chmod go-wx /etc/cron.hourly

chmod go-wx /etc/cron.daily

chmod go-wx /etc/cron.weekly

chmod go-wx /etc/cron.monthly
```

### 6. Настройка механизмов защиты ядра Linux

Файл sysctl.conf в Linux системах представляет собой конфигурационный файл, используемый для настройки параметров ядра операционной системы, управляемых через sysctl (системный вызов). Этот файл содержит параметры, определяющие различные аспекты поведения ядра, такие как сетевые настройки, настройки безопасности, параметры виртуальной памяти и т. д. 

Изменения в sysctl.conf вступают в силу после перезагрузки системы или после применения изменений с помощью команды sysctl -p.

Чтобы внести правки, откройте файл - **/etc/sysctl.conf**

И внесите строчку - 

```
kernel.dmesg_restrict=1
```

![Картинка](Screen6.png)

Убедиться, что правило написано верно можно с помощью команды

```
sysctl -p
```

![Картинка](Screen7.png)

Если в ответ вернется введеная вами строка - вы сделали все правильно. Если была бы ошибка, то вывод команды был следующим:

![Картинка](Screen8.png)

### И стоит сказать, что далее почти весь документ ФСТЭК РФ посвящен именно вопросу настройки файла sysctl.conf

Если подводить итог, зачем данный файл необходим, то можно прийти к следующим выводам:

1. Настройка параметров ядра: С помощью файлов sysctl.conf можно устанавливать и изменять параметры, которые касаются работы ядра Linux, такие как максимальное количество открытых файлов, размер буфера памяти и другие системные настройки. Конфигурирование этих параметров может помочь оптимизировать работу системы и обеспечить ее более эффективную работу.

2. Контроль сетевых параметров: Sysctl.conf также позволяет настраивать параметры сети, такие как размеры буферов, TTL (время жизни) пакета и другие сетевые настройки. Это позволяет управлять сетевыми ресурсами и обеспечить более безопасную и эффективную работу в сетевой среде.

3. Обеспечение безопасности: Помимо параметров ядра и сети, sysctl.conf также может быть использован для повышения безопасности системы. Настройка различных параметров позволяет усилить защиту операционной системы от возможных угроз и атак. Например, можно изменить параметры, связанные с отслеживанием IP пакетов, настройкой IPv6, включением и отключением различных механизмов безопасности.


# Дополнительная информация:
1) ФСТЭК РФ  [Ссылка](https://fstec.ru/dokumenty/vse-dokumenty/spetsialnye-normativnye-dokumenty/metodicheskij-dokument-ot-25-dekabrya-2022-g)
2) SYSCTL Conf - примеры использования[Ссылка](https://www.cyberciti.biz/faq/linux-kernel-etcsysctl-conf-security-hardening/)
3) PAM в Astra Linux [Ссылка](https://habr.com/ru/companies/aktiv-company/articles/144700/)


