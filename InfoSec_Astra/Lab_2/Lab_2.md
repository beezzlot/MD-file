# Лабораторная работа №2. Тема: "Настройка межсетевого  экрана"
Цель работы
----------

познакомиться с UFW - основным решением межсетевого экранирования в Astra Linux.


Оборудование, ПО:
----------
Виртуальная машина под управлением ОС Astra Linux 1.7  в режиме защищенности "Воронеж".


Ход работы:
----------
UFW, или Uncomplicated Firewall, является основным инструментом для настройки и управления файерволом в операционной системе  Astra Linux. С помощью UFW вы можете задать правила доступа к сети для различных сервисов и приложений.

В этом курсе мы рассмотрим основные возможности и функционал UFW, научимся его устанавливать, настраивать и использовать для защиты вашей системы от внешних угроз.


# UFW, iptables, nftables - сколько можно то?! 

Да, если вы уже имели опыт работы с разными дистрибутивами Linux, то наверняка сталкивались с тем, что решения для межсетевого экрана бывают разные - iptables, nftables, firewalld, ufw. 

Но что их всех объединяет? 

### Все они используют модуль ядра netfilter!

А в случае с некоторыми другими решениями, как например, UFW, они являются "обвязкой над обвязкой", так как UFW использует iptables для формирования правил, а затем уже переводит для работы с netfilter.

В любом случае, правило работы с трафиком сводится к данной схеме. Она описывает весь процесс обработки трафика на компьютере под управлением Linux.

Также, стоит добавить, что UFW инструмент не гибкий. При настройке сложных правил придется прибегнуть к чистому **iptables**. 

![Картинка](image.png)

Постараемся предметно разобраться в значении данной схемы. 

1) Каждый этап работы с трафиком именнуется цепочкой, а внутри "цепочек" находятся таблицы, которые содержат правила по работе с трафиком. Данные конструкции работают в следующем порядке:

  * PREROUTING (премаршрутизация) - в этой цепочке содержатся правила, которые работают до того, как компьютер сформирует и отправит IP-пакет в сеть. Здесь допустимо настроить таблицу NAT - если есть задача "подменить" адрес источника непосредственно на отправителе или промаркировать трафик меткой в таблице MANGLE. 

===Далее выполняется маршрутизация, а затем трафик перейдет в цепочку INPUT, если он  является входящим соединением и должен быть обработан внутренним процессом, или же в ветку FORWARD, если трафик должен уйти в сеть к другому устройству===

Например, мы попадем в **INPUT**

  * В этом случае, цепочка INPUT встретит нас следующим набором таблиц - 
  
    1. MANGLE (для маркировки);
    
    2. filter (для того чтобы отфильтровать нежелательный входящий трафик);
    
    3. conntrack (если входящий трафик допустим, но необходимо отслеживать его состояние).  Если трафик не был отфильтрован в ходе работы, то он передается на прикладной уровень по модели OSI - сервисам и программам, которые запущены на компьютере.

#### Немного отступим от темы и обсудим что такое conntrack

Один из примеров использования conntrack в iptables - это настройка правил для обеспечения безопасности сервера. Например, можно настроить правило, которое разрешает входящие соединения только на определенные порты (например, порт 80 для HTTP) и отслеживает состояние этих соединений с помощью conntrack.

Допустим, у вас есть веб-сервер, который должен принимать только HTTP-запросы на порт 80. Вы можете создать правило в iptables с использованием conntrack, которое будет отслеживать состояние соединений на этом порте:

```
iptables -A INPUT -p tcp --dport 80 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j REJECT
```

В приведенном примере правило позволяет только устанавливать новые и установленные соединения на порт 80, отклоняя все остальные входящие соединения на этот порт. Таким образом, использование conntrack позволяет более точно контролировать поток трафика и улучшить безопасность сервера, предотвращая несанкционированные подключения.

 * Если трафик был обработан внутренними процессами системы и должен вновь вернуться в сеть (если, например, мы с АРМ используем какой-нибудь клиент-серверное приложение), то мы перейдем в цепочку **OUTPUT**. Здесь нас встретят следующие таблицы (указаны в порядке обработки) - 

      1. raw - буквально "сырая" таблица. Разместить в неё можно любое правило;

      2. conntraсk;

      3. mangle;

      4. nat;

      5. filter.

* После **OUTPUT** пакет должен отправиться в процесс маршрутизации и цепочку **POSTROUTING**. Таблицы будут следующими: 

  1. mangle;

  2. NAT - причем здесь "NAT* правило сработает только при условии, что пакет должен направиться за пределы локальной сети. Например, если из Linux делать роутер, то команда для NAT будет следующей:

  ```
  iptables -t nat -A POSTROUING -s 0.0.0.0/0 -o eth0 -j MASQUERADE
  ```

Разберем команду выше - 

1. -t nat - указываем таблицу NAT

2. -A POSTROUTING - указываем цепочку POSTROUING в таблице NAT

3. -s 0.0.0.0/0 - здесь могла бы быть ваша локальная подсеть (например, 192.168.1.0/24), но также допустимо использование wildcard. В этом случае под правило попадает любая подсеть. 

4. -o eth0. Здесь o - outside. Считайте, как outside-интерфейс. Или в какой адрес выполнять трансляцию (NAT) - в адрес, указанный на интерфейсе eth0.

5. -j MASQUERADE. Здесь j - jump, имеется ввиду как "Action". MASQUERADE  в терминологии iptables - это PAT, или NAT Overload, или NAT с перегрузкой. Названий у этой технологии много, но суть одна - транслируем не "адрес в адрес", а "адрес в порт". Так рациональнее. 

## Забыли поговорить о цепочке FORWARD

Действительно, увлеклись мы маршрутом через цепочку **INPUT**, а что с **FORWARD**? 

Таблиц в этой цепочке немного: 

1. mangle;

2. filter. 

В цепочку **FORWARD** трафик попадает при условии, что ваше устройство является промежуточным в компьютерной сети - то есть роутером! Случай, довольно редкий для АРМ, но вполне "ожидаемый" если вдруг из ПК на базе Astra Linux решили сделать маршрутизатор. 

# Фух, теорию мы изучили подробно. Отправляемся практиковаться с UFW. 























# Практическая работа

1) На полученной виртуальной машине создайте пользователя engineer, настройте шаблон пользователей так, чтобы он был автоматически добавлен в группу astra-admin.

2) Установите минимальную длину пароля - 10 символов;

3) Установите минимальное количество строчных букв в новом пароле - 2 символа;

4) Установите минимальное количество заглавных букв в новом пароле - 2 символа;

5) Установите минимальное количество цифр в новом пароле - 5 символов;

6) Пользователям из группы IT (создайте её, если такой нет) разрешите доступ к команде tar с использованием sudo.




# Дополнительная информация:
1) Информация о репозиториях Astra Linux [Ссылка](https://wiki.astralinux.ru/pages/viewpage.action?pageId=158598882)
2) Информация о уровнях конфиденциальности [Ссылка](https://wiki.astralinux.ru/pages/viewpage.action?pageId=27362553)
3) Подборка материалов по Системам защиты информации в Astra Linux [Ссылка](https://telegra.ph/Podborka-materialov-po-SZI-Astra-Linux-11-25)
4) Документация [Ссылка](https://wiki.astralinux.ru/pages/viewpage.action?pageId=137563555)
5) Как переключать режимы защищенности в Astra Linux? [Ссылка](https://wiki.astralinux.ru/pages/viewpage.action?pageId=109020865)
