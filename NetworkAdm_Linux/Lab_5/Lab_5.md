# Лабораторная работа №5. Тема: "Конфигурация параметров аутентификации и прав доступа"
Цель работы
----------

Освоить ключевые навыки настройки параметров аутентификации и прав доступа на базе ОС Astra Linux.


Оборудование, ПО:
----------
Виртуальная машина под управлением ОС Astra Linux 1.7  в режиме защищенности "Воронеж"


Ход работы:
----------

# Начнем с начала, как в Linux в целом рабротает хранение данных? 

Добавляя в систему новый диск (под словом диск, в рамках этой работы мы понимаем любой блочный накопитель - SSD, HDD, NVME) он отображается в системе уникальной буквой.

В Linux диски называются sda, sdb, sdc и так далее в соответствии с схемой именования дисков SCSI/SATA/USB. Буква "sd" означает, что это SCSI/SATA/USB устройство, а буква после "d" обозначает порядковый номер устройства в системе. Так, sda обычно относится к первому SCSI/SATA/USB диску, sdb - ко второму, sdc - к третьему, и т.д.

Стоит обратить внимание, что наименование может отличаться в зависимости от сервера\компьютера\драйверов и специфики аппартной части!

## А что у нас на стендах? 

Команда **lsblk** укажет информацию о всех доступных блочных устройствах. Обратите внимание на **sdb**, **sdc**, **sdd**.


![Картинка](Screen1.png)

На каждой виртуальной машине есть 3 диска по 1Гб - это тренировочные диски, которые очень пригодятся нам для экспериментов с LVM.

Сам по себе диск не может хранить информации, если не будет создан раздел и не будет установлена файловая система. 

Раздел на диске может быть произвольного объема, а также может быть несколько разделов (максимум 4).

Например, разметим **/dev/sdb** на один единый раздел, объемом на весь диск. Сделать это можно тремя инструментами: 

* fdisk;

* cfdisk;

* gparted. 

Как это сделать через [fdisk](https://losst.pro/komanda-fdisk-v-linux), а как через [gparted](https://help.ubuntu.ru/wiki/gparted)

А в рамках данной лабораторной работы мы рассмотрим инструмент cfdisk.

Испольуем команду:

```
cfdisk /dev/sdb
```

![Картинка](Screen2.png)

В качестве метки выбираем GPT.

![Картинка](Screen3.png)

Размер раздела - 1Гб (или 1023Мб, как выбрано, по умолчанию)

![Картинка](Screen4.png)

Далее необходимо выбрать тип раздела - Linux LVM

![Картинка](Screen5.png)

И в списке доступных разделов и форматов:

![Картинка](Screen6.png)

И в конце - "Запись"

![Картинка](Screen7.png)

Подтвердите операцию командой "yes". Проверить, что все работает можно командой: 

```
lsblk
```

![Картинка](Screen8.png)

Повторите создание раздела для всех дисков. 

![Картинка](Screen9.png)

# Отлично, теперь у нас три диска с разделами. Пора поговорить о LVM.

Логические тома (Logical Volumes) в LVM - это виртуальные разделы диска, которые создаются на базе физических дисков. Они могут быть изменены без необходимости переноса данных, в отличие от обычных разделов.

Группы томов (Volume Groups) в LVM объединяют несколько физических дисков или RAID массивов в одну логическую единицу. Группы томов служат для управления большим объемом дискового пространства и деления его на логические тома для удобства управления и обеспечения отказоустойчивости.

Таким образом, логические тома создаются внутри групп томов, что позволяет гибко управлять дисками, изменять их размеры, создавать резервные копии, устанавливать зеркальное отражение данных и многое другое. Использование LVM позволяет эффективно управлять дисками и обеспечивает высокую гибкость и надежность системы хранения данных.

![Картинка](Screen11.png)

Поговорим о данной архитектуре. 

Читаем снизу вверх. 

1. Диски - это ваши основные физические блочные устройства. 

2. Разделы - разметили таблицу разделов, создали файловую систему. Получился готовый раздел. Его можно использовать для монтирования в различные каталоги Astra Linux.

3. Физические тома. Теперь мы говорим о LVM. В этом контексте - физический том это любой раздел на диске, который был проинициализирован для использования LVM-массивом. 

4. Группы томов. Проинициализированные диски добавляем в общую группу томов. Объем всех дисков суммируется в общее пространство памяти.

5. Логический том. Большое пространство группы томов мы можем разделять на логические тома (словно как разделы на блочных дисках). 

6. Файловая система. Логический том требует установленной в него файловой системы. После её установки мы можем монтировать данный логический том в директории нашей хостовой ОС для хранения информации.

LVM  является удобным и мощным инструментом для управления хранилищем данных в Linux. Вот несколько плюсов и минусов использования LVM:

Плюсы:
1. Гибкое управление: с помощью LVM вы можете легко изменять размеры логических разделов, создавать снимки файловой системы, объединять различные устройства хранения в один "пул данных" и многое другое без даунтайма вашего сервера.

2. Высокая надежность: использование LVM позволяет создавать резервные копии данных, восстанавливаться после сбоев и улучшить производительность хранилища.

3. Возможность разделения на логические тома: это позволяет изолировать данные и при необходимости управлять ими отдельно.

Минусы:
1. Сложность настройки: для новичков может быть непросто разобраться во всех возможностях LVM и настроить его правильно.

2. Риск потери данных: неправильная конфигурация LVM может привести к потере доступа к данным или их полной потере.

3. Дополнительные нагрузки на систему: использование LVM может повлечь за собой дополнительное потребление ресурсов системы и снижение производительности.

В целом, несмотря на некоторые сложности, LVM является мощным инструментом для управления хранилищем данных в Linux и может значительно упростить администрирование системы.

## С теорией понятно, приступим к практике? 

Для работы с LVM помните "трёх китов", на которых держится данная технология: 

1. Физические тома (Physical Volume)

2. Группы томов (Volume Group)

3. Логические тома (Logical Volume)


* Установить lvm2 - набор утилит для работы с технологией:

```
apt install lvm2
```



* Инициализация физического тома: 

```
pvcreate /dev/sdb1 /dev/sdc1/ /dev/sdd1
```

![Картинка](Screen12.png)

Проверить состояние физических томов можно командами: 

```
pvs
```

или более подробная 

```
pvdisplay
```



* Создать группу томов **vg-group**

```
vgcreate vg-group /dev/sdb1 /dev/sdc1 /dev/sdd1
```

**Вместо vg-group, конечно, можно написать другое имя желаемой группы томов**

Проверить состояние группы томов можно командами: 

```
vgs
```

или более подробная 

```
vgdisplay
```


* Создать логический том можно командами: 

Но перед началом, давайте посмотрим справку по команде **lvcreate**

```
lvcreate --help
```

Справка - огромная! Всю информацию в рамках нашей лабораторной работы изучить будет нереально. Рассмотрим две команды для создание логического тома. 

Например, команда ниже создаст логический том объемом в 350 Мб. -

```
lvcreate -L 350m -n Data vg-group
```

Другая команда, создаст логический том в размере 40% от всего свободного пространства нашей группы томов.

```
lvcreate -l 40%FREE -n Storage vg-group
```

![Картинка](Screen13.png)

Посмотреть статус логических томов:

```
lvs
```

Или более подробный

```
lvdisplay
```

### Фух, сколько дел! Теперь можно на LVM хранить информацию?

Нет! А как же без файловой системы? 

Команда mkfs в Linux используется для создания файловых систем на различных устройствах хранения данных, таких как жесткие диски, флэш-накопители и т. д. Скрипты mkfs позволяют автоматизировать этот процесс, делая его более удобным и эффективным.

Многие администраторы систем используют скрипты mkfs для создания файловых систем с определенными параметрами и настройками. Например, скрипт mkfs.ext4 создаст файловую систему ext4 с выбранными опциями, такими как размер индексов, дополнительные параметры целостности данных и т. д.

**Для установки ФС на логический том Data, команда будет**

```
mkfs.ext4 /dev/mapper/vg--group-Data
```

Для Storage аналогичная. Теперь разделы готовы к работе!

Создайте каталоги **/storage** и **/data**, примонтируйте логические LVM-тома в созданные директории

![Картинка](Screen14.png)

# А теперь поговорим о создании доступа до этих каталогов?

Samba и NFS - это два популярных протокола для совместного использования файлов и ресурсов в сетях с использованием Linux.

Samba:
1. Samba - это протокол для обмена файлами и ресурсами между устройствами в сети, поддерживающий работу с Windows и Linux.
2. С помощью Samba вы можете создавать общие папки и принтеры, управлять пользователями и группами доступа, а также обеспечивать доступ к файлам и папкам по сети через протоколы SMB/CIFS.
3. Samba позволяет взаимодействовать между компьютерами с различными операционными системами, обеспечивая совместимость и удобство использования общих ресурсов.

NFS:
1. NFS (Network File System) - это протокол для удаленного доступа к файловой системе через сеть, который широко используется в UNIX-подобных системах, включая Linux.
2. С помощью NFS вы можете монтировать удаленные каталоги как локальные на своем компьютере, обеспечивая доступ к файлам и данным на удаленных серверах.
3. NFS обладает высокой производительностью и эффективностью, и интегрируется непосредственно в файловую систему операционной системы, что упрощает работу с удаленными данными.

Кратко говоря, Samba обеспечивает совместимость с Windows и Linux, позволяя обмениваться файлами и ресурсами между ними, в то время как NFS предоставляет удаленный доступ к файлам на сервере по сети в UNIX-подобных системах. Оба протокола могут быть полезны в среде Linux для обеспечения совместного доступа к данным и ресурсам.


## Начнем с Samba.

1. Установите пакет samba на вашем сервере (если он еще не установлен):

```
sudo apt install samba
```

2. Отредактируйте файл конфигурации smb.conf. Добавьте в него настройки для создания общей папки:

```
/etc/samba/smb.conf
```

3. Внутри файла smb.conf добавьте следующий блок конфигурации (достаточно указать его в конце файла) для создания общей папки:

```
[shared_folder]
   path = /storage
   writable = yes
   guest ok = yes
```

  Где:
   - [shared_folder] - это имя общей папки, которое будет отображаться для пользователей.
   - path - это путь к каталогу на сервере, который будет общим, укажите LVM-массив "Storage"
   - writable = yes - разрешает пользователям запись в общую папку.
   - guest ok = yes - разрешает гостевой доступ, без необходимости аутентификации.

Да, начнем с простой общей папки без авторизации. После выполнения настроек выше, не забудьте перезагрузить службу Samba:

```
sudo systemctl restart smbd
```

## А как проверить? 

Откройте проводник FLY, в адресной строке укажите **smb://127.0.0.1**

![Картинка](Screen16.png)

Ваша папка готова к работе. 

## Хочу авторизацию, чтобы безопасно было!

Для этого надо создать локального пользователя, а затем добавить его в Samba

1. Создаем локально

```
adduser samba-user
```

2. Добавляем в Samba.

![Картинка](Screen17.png)

Кстати, пароль для пользователя в самой ОС и его пароль в Samba может отличаться.

3. В конфигурационный файл **/etc/samba/smb.conf** добавьте: 

```
[sambashare]
   path = /data
   valid users = samba-user
   writeable = yes
   browseable = yes
   create mask = 0777
   directory mask = 0777
```

4. Перезагрузите Samba: 

```
sudo systemctl restart smbd
```

### Проверить получиться через командную строку

```
smbclient \\\\127.0.0.1\\sambashare -U samba-user
```

![Картинка](Screen18.png)

Для анонимного доступа команда была бы:

```
smbclient -N \\\\hostname\\share
```

# А что там про NFS? 

1. Для начала установим: 

```
sudo apt-get install nfs-server nfs-common
```

2. Далее создайте каталог, который планируется к публикации в NFS. 

С целью закрепления материала по LVM, создайте логический том объемом в 100 Мб и смонтируйте его в каталог /nfs

![Картинка](Screen19.png)

3. Перейдем в основной конфигурационный файл настроек NFS - **/etc/exports**. Добавьте там строку: 

```
/nfs *(rw,sync,no_subtree_check)
```

Эти строки в файле конфигурации /etc/exports определяют правила доступа к общей папке NFS (Network File System) на сервере. Давайте рассмотрим каждый флаг:

1. **/nfs**: Это путь к общей папке на сервере, к которой будет осуществляться доступ по протоколу NFS.

2. *: Это определяет список IP-адресов или доменов, которые имеют доступ к общей папке. Символ * означает, что доступ разрешен для всех IP-адресов (любого клиента).

3. **rw**: Этот флаг обозначает, что общая папка доступна для чтения и записи (read-write).

4. **sync**: Этот флаг указывает, что изменения данных должны быть синхронизированы на диск немедленно. Это повышает надежность, но может замедлить работу системы.

5. **no_subtree_check**: Этот флаг отключает проверку поддерева (subtree check), что позволяет упростить настройку и снизить нагрузку на сервер.

После внесения изменений в файл /etc/exports, необходимо перезапустить службу NFS, чтобы изменения вступили в силу:

```
systemctl restart nfs-server
```

6. Пора проверить!

Для начала создадим точку монтирования удаленной общей папки:

```
mkdir /mnt/nfs
```

А затем примонтируем удаленный ресурс: 

```
sudo mount -t nfs 127.0.0.1:/nfs /mnt/nfs
```

Общая папка успешно смонтирована: 

![Картинка](Screen20.png)



# Практическая работа

1) На созданном LVM-массиве создайте логический том: 

    * ShareFolder, объемом в 20% от всего доступного пространства;
    
    * В качестве файловой системы используйте XFS;

    * В качестве точки монтирования - /mnt/share.

2) Создайте Samba папку:

  * Скройте папку из Browseable;

  * На рабочем столе пользователя Lihanov создайте ярлык для доступа к этому общему ресурсу.


# Дополнительная информация:
1) Samba в Astra Linux [Ссылка](https://wiki.astralinux.ru/display/doc/Samba)
2) NFS в Astra Linux  [Ссылка](https://wiki.astralinux.ru/pages/viewpage.action?pageId=27362314)
3) NFS с аутентификацией в домене FreeIPA  [Ссылка](https://wiki.astralinux.ru/pages/viewpage.action?pageId=105976211)
4) LVM - это просто! [Ссылка](https://habr.com/ru/articles/67283/)


